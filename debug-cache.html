<!DOCTYPE html>
<html>
<head>
    <title>CTT Cache Debug</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #0A0A0A;
            color: #00FF00;
        }
        h1 { color: #A855F7; }
        button {
            background: #A855F7;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover { background: #9333EA; }
        .output {
            background: #141414;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 600px;
            overflow-y: auto;
        }
        .error { color: #FF0000; }
        .success { color: #00FF00; }
        .warning { color: #FFA500; }
        .info { color: #00FFFF; }
    </style>
</head>
<body>
    <h1>ğŸ” CTT Cache Debugger</h1>
    
    <div>
        <button onclick="checkAll()">ğŸ” Alles PrÃ¼fen</button>
        <button onclick="checkBackup()">ğŸ“¦ Backup PrÃ¼fen</button>
        <button onclick="checkOldCache()">ğŸ—‚ï¸ Alte Keys PrÃ¼fen</button>
        <button onclick="clearAll()">ğŸ—‘ï¸ Alles LÃ¶schen</button>
        <button onclick="window.location.href='index.html'">ğŸ”„ Zur App</button>
    </div>
    
    <div class="output" id="output">Klicke auf einen Button...</div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script>
        function log(msg, type = 'info') {
            const output = document.getElementById('output');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = msg + '\n';
            output.appendChild(span);
        }
        
        function clear() {
            document.getElementById('output').textContent = '';
        }
        
        function checkBackup() {
            clear();
            log('ğŸ“¦ PrÃ¼fe ctt_backup...', 'info');
            
            const backup = localStorage.getItem('ctt_backup');
            if (!backup) {
                log('âŒ Kein ctt_backup gefunden!', 'error');
                return;
            }
            
            log(`âœ… ctt_backup gefunden: ${(backup.length / 1024).toFixed(2)} KB (Base64)`, 'success');
            
            try {
                // Dekodiere Base64
                const chunkSize = 8192;
                const chunks = [];
                
                for (let i = 0; i < backup.length; i += chunkSize) {
                    const chunk = backup.slice(i, i + chunkSize);
                    const decoded = atob(chunk);
                    for (let j = 0; j < decoded.length; j++) {
                        chunks.push(decoded.charCodeAt(j));
                    }
                }
                
                const compressed = new Uint8Array(chunks);
                log(`âœ… Dekodiert: ${(compressed.length / 1024).toFixed(2)} KB (komprimiert)`, 'success');
                
                // Dekomprimiere
                const decompressed = pako.ungzip(compressed, { to: 'string' });
                log(`âœ… Dekomprimiert: ${(decompressed.length / 1024).toFixed(2)} KB (JSON)`, 'success');
                
                // Parse JSON
                const data = JSON.parse(decompressed);
                log('\nğŸ“Š Daten-Inhalt:', 'info');
                log(`   Users: ${data.users?.length || 0}`, 'info');
                log(`   Projects: ${data.projects?.length || 0}`, 'info');
                log(`   TimeEntries: ${data.timeEntries?.length || 0}`, 'info');
                log(`   AbsenceRequests: ${data.absenceRequests?.length || 0}`, 'info');
                log(`   Version: ${data.version}`, 'info');
                log(`   Timestamp: ${data.timestamp}`, 'info');
                
                if (data.favoriteProjectIds) {
                    log(`   FavoriteProjects: ${data.favoriteProjectIds.length}`, 'info');
                }
                if (data.pinnedTasks) {
                    log(`   PinnedTasks: ${data.pinnedTasks.length}`, 'info');
                }
                
                log('\nâœ… Backup ist gÃ¼ltig!', 'success');
                
            } catch (error) {
                log(`\nâŒ Fehler beim Dekodieren: ${error.message}`, 'error');
                log('ğŸ’¡ Cache ist korrupt - sollte gelÃ¶scht werden!', 'warning');
            }
        }
        
        function checkOldCache() {
            clear();
            log('ğŸ—‚ï¸ PrÃ¼fe alte Cache-Keys...', 'info');
            
            const oldKeys = ['ctt_users', 'ctt_projects', 'ctt_timeEntries', 'ctt_absenceRequests', 'ctt_session'];
            let found = false;
            
            oldKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    found = true;
                    log(`âš ï¸ ${key}: ${(data.length / 1024).toFixed(2)} KB (VERALTET!)`, 'warning');
                }
            });
            
            if (!found) {
                log('âœ… Keine alten Keys gefunden', 'success');
            } else {
                log('\nğŸ’¡ Alte Keys sollten gelÃ¶scht werden!', 'warning');
            }
        }
        
        function checkAll() {
            clear();
            log('ğŸ” VollstÃ¤ndige Cache-PrÃ¼fung...\n', 'info');
            
            // Gesamt-GrÃ¶ÃŸe
            let totalSize = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage.getItem(key).length;
                }
            }
            log(`ğŸ“Š Gesamt localStorage: ${(totalSize / 1024).toFixed(2)} KB\n`, 'info');
            
            // Backup prÃ¼fen
            checkBackup();
            log('\n---\n', 'info');
            
            // Alte Keys prÃ¼fen
            checkOldCache();
        }
        
        function clearAll() {
            clear();
            log('ğŸ—‘ï¸ LÃ¶sche alle Cache-Daten...\n', 'warning');
            
            // Backup
            localStorage.removeItem('ctt_backup');
            log('âœ… ctt_backup gelÃ¶scht', 'success');
            
            // Alte Keys
            const oldKeys = ['ctt_users', 'ctt_projects', 'ctt_timeEntries', 'ctt_absenceRequests', 'ctt_session'];
            oldKeys.forEach(key => {
                localStorage.removeItem(key);
                log(`âœ… ${key} gelÃ¶scht`, 'success');
            });
            
            log('\nâœ… Alle Daten gelÃ¶scht!', 'success');
            log('ğŸ”„ Bitte Seite neu laden (zur App gehen)', 'info');
        }
    </script>
</body>
</html>
